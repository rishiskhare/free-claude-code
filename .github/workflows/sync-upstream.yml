name: Sync Fork with Upstream

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Sync but do not push (dry-run mode)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      UPSTREAM_REPO: Alishahryar1/free-claude-code
      UPSTREAM_BRANCH: main
      FORK_BRANCH: main

    steps:
      - name: Checkout fork
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git" 2>/dev/null || true
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}" --no-tags

      - name: Detect upstream force-push
        id: force_push
        run: |
          MERGE_BASE=$(git merge-base HEAD "upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null || echo "")
          if [ -z "$MERGE_BASE" ]; then
            echo "detected=true" >> "$GITHUB_OUTPUT"
            echo "::error::No common ancestor with upstream — upstream may have been force-pushed or rewritten."
            exit 1
          fi
          # Check that the merge-base is reachable from upstream (i.e. upstream still contains our shared history)
          if ! git merge-base --is-ancestor "$MERGE_BASE" "upstream/${{ env.UPSTREAM_BRANCH }}"; then
            echo "detected=true" >> "$GITHUB_OUTPUT"
            echo "::error::Merge-base is not an ancestor of upstream HEAD — upstream history was rewritten."
            exit 1
          fi
          echo "detected=false" >> "$GITHUB_OUTPUT"
          echo "merge_base=$MERGE_BASE" >> "$GITHUB_OUTPUT"

      - name: Check for new upstream commits
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD.."upstream/${{ env.UPSTREAM_BRANCH }}")
          if [ "$BEHIND" -eq 0 ]; then
            echo "status=up-to-date" >> "$GITHUB_OUTPUT"
            echo "::notice::Already up to date with upstream."
          else
            echo "status=behind" >> "$GITHUB_OUTPUT"
            echo "behind=$BEHIND" >> "$GITHUB_OUTPUT"
            UPSTREAM_HEAD=$(git rev-parse "upstream/${{ env.UPSTREAM_BRANCH }}")
            echo "upstream_head=${UPSTREAM_HEAD}" >> "$GITHUB_OUTPUT"
            echo "::notice::$BEHIND commit(s) behind upstream."
          fi

      - name: Merge upstream (upstream wins on conflicts)
        if: steps.check.outputs.status == 'behind'
        id: merge
        run: |
          FORK_HEAD_BEFORE=$(git rev-parse HEAD)
          echo "fork_head_before=${FORK_HEAD_BEFORE}" >> "$GITHUB_OUTPUT"

          if git merge "upstream/${{ env.UPSTREAM_BRANCH }}" -X theirs --no-edit \
            -m "Merge upstream/${{ env.UPSTREAM_BRANCH }} into ${{ env.FORK_BRANCH }} [skip ci]"; then
            echo "result=merged" >> "$GITHUB_OUTPUT"
          else
            git merge --abort 2>/dev/null || true
            echo "result=failed" >> "$GITHUB_OUTPUT"
            echo "::error::Merge failed with tree/structural conflicts. Manual intervention required."
            exit 1
          fi

      - name: Reapply fork overrides
        if: steps.check.outputs.status == 'behind'
        run: |
          # Keep fork-owned workflow files to avoid workflow-permission push rejections.
          git restore --source=HEAD^1 -- .github/workflows
          python3 scripts/sync_readme.py
          cp -f fork/claude-free claude-free
          chmod +x claude-free
          if [ -n "$(git status --porcelain)" ]; then
            git add .github/workflows README.md claude-free
            git commit -m "chore: reapply fork overrides after upstream sync [skip ci]"
          fi

      - name: Push changes
        if: steps.check.outputs.status == 'behind' && inputs.dry_run != 'true'
        run: |
          if git push origin "${{ env.FORK_BRANCH }}"; then
            echo "::notice::Push succeeded."
          else
            echo "::error::Push failed. This is usually permissions or non-fast-forward. Re-run after resolving branch state."
            exit 1
          fi

      - name: Dry-run notice
        if: steps.check.outputs.status == 'behind' && inputs.dry_run == 'true'
        run: |
          echo "::notice::Dry-run mode — skipped push. The following commits would be pushed:"
          git log --oneline "origin/${{ env.FORK_BRANCH }}..HEAD"

      - name: Summary
        if: always()
        run: |
          {
            echo "## Upstream Sync"
            echo ""
            if [ "${{ steps.check.outputs.status }}" = "up-to-date" ]; then
              echo "Already up to date with upstream."
            elif [ "${{ steps.merge.outputs.result }}" = "failed" ] || [ "${{ steps.force_push.outputs.detected }}" = "true" ]; then
              echo "Sync **failed**. Manual intervention required."
              echo ""
              if [ "${{ steps.force_push.outputs.detected }}" = "true" ]; then
                echo "**Reason:** Upstream force-push detected."
              else
                echo "**Reason:** Merge conflicts that could not be auto-resolved."
              fi
            else
              echo "Merged **${{ steps.check.outputs.behind }}** upstream commit(s) via \`${{ steps.merge.outputs.result }}\` strategy."
              echo ""
              echo "Fork overrides reapplied after merge."
              if [ "${{ inputs.dry_run }}" = "true" ]; then
                echo ""
                echo "> **Dry run** — changes were not pushed."
              fi
              echo ""
              REPO="${{ github.repository }}"
              BEFORE="${{ steps.merge.outputs.fork_head_before }}"
              AFTER="$(git rev-parse HEAD)"
              if [ -n "$BEFORE" ] && [ -n "$AFTER" ] && [ "$BEFORE" != "$AFTER" ]; then
                echo "[View diff](https://github.com/${REPO}/compare/${BEFORE}...${AFTER})"
              fi
            fi
          } >> "$GITHUB_STEP_SUMMARY"
